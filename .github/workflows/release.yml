name: release

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: build macOS
    runs-on: macos-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Add rustup macOS target
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build default target in release mode
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build Apple ARM64 target in release mode
        run: cargo build --release --target aarch64-apple-darwin

      - name: Get latest release version number
        id: get_version
        uses: battila7/get-version-action@v2

      - name: Create tar.gz file on macOS
        run: |
          chmod +x target/x86_64-apple-darwin/release/laraveltips
          tar -zcf target/x86_64-apple-darwin/release/laraveltips-${{ steps.get_version.outputs.version }}-x86_64-apple-darwin.tar.gz -C target/x86_64-apple-darwin/release laraveltips
          chmod +x target/aarch64-apple-darwin/release/laraveltips
          tar -zcf target/aarch64-apple-darwin/release/laraveltips-${{ steps.get_version.outputs.version }}-aarch64-apple-darwin.tar.gz -C target/aarch64-apple-darwin/release laraveltips

      - name: Upload release and assets to GitHub
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          release_name: laraveltips ${{ steps.get_version.outputs.version }}
          file_glob: true
          file: target/*/release/laraveltips-${{ steps.get_version.outputs.version }}-*.{zip,tar.gz}
